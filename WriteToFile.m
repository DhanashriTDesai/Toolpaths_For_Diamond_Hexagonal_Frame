%%% This function generates the G-code file according to the nodal path 
% and feed rate data %%%

function WriteToFile(CellType,NodalPath,nx,ny,E,nH,nV, ...
    nExtr,nL)

switch CellType
    case 'StretchDominatedDiamond'
        fileID = fopen('DiamondCellGcode.gcode','wt'); 
    case 'BendingDominatedHexagon'
        fileID = fopen('HexagonalCellGcode.gcode','wt'); 
end

% Initial house-keeping commands
fprintf(fileID,strcat(';FLAVOR:Marlin','\n',';TIME:6','\n',';Layer height: 2','\n',';MINX:10','\n',';MINY:0', ...
    '\n',';MINZ:2','\n',';MAXX:240','\n',';MAXY:230','\n',';MAXZ:2','\n','T1','\n','M140 S70','\n','M105','\n','M190 S70','\n','M105','\n','M82 ;absolute extrusion mode', ...
    '\n','G21 ;metric values','\n','M107','\n','G28','\n','M420 S1','\n','G90 ;absolute positioning','\n','G92 E0; reset extruder distance', ...
    '\n','G1 X0 Y0 Z10 F5000 ;move nozzle up 10mm for safe homing','\n','M500','\n','M82 ;set extruder to absolute mode', ...
    '\n','M107 ;start with the fan off','\n','G92 E0 ;zero the extruded length','\n','M117 Printing...','\n','G92 E0','\n','G92 E0' ...
    ,'\n',';LAYER_COUNT:1','\n',';LAYER:0','\n','M107','\n','\n','\n','\n','\n')); 

% Prime tower gcode - generated using Ultimaker CURA
fprintf(fileID,strcat('\n','\n','\n','\n','\n',';MESH:SlurryPrimeTower.stl','\n','G0 F3600 X16.778 Y13.684 Z2', ...
    '\n',';TYPE:WALL-OUTER','\n','G1 F420 X20.677 Y11.697 E0.07278','\n','G1 X25 Y11.013 E0.14556', ...
    '\n','G1 X29.323 Y11.697 E0.21835','\n','G1 X33.222 Y13.684 E0.29112','\n','G1 X36.316 Y16.778 E0.36389', ...
    '\n','G1 X38.303 Y20.677 E0.43666','\n','G1 X38.987 Y25 E0.50945','\n','G1 X38.303 Y29.323 E0.58224', ...
    '\n','G1 X36.316 Y33.222 E0.65501','\n','G1 X33.222 Y36.316 E0.72778','\n','G1 X29.323 Y38.303 E0.80055', ...
    '\n','G1 X25 Y38.987 E0.87334','\n','G1 X20.677 Y38.303 E0.94612','\n','G1 X16.778 Y36.316 E1.0189', ...
    '\n','G1 X13.684 Y33.222 E1.09167','\n','G1 X11.697 Y29.323 E1.16444','\n','G1 X11.013 Y25 E1.23723' ...
    ,'\n','G1 X11.697 Y20.677 E1.31001','\n','G1 X13.684 Y16.778 E1.38279','\n','G1 X16.778 Y13.684 E1.45555', ...
    '\n','G0 F3600 X17.668 Y13.23','\n','G0 X17.962 Y15.314','\n',';TYPE:SKIN','\n','G1 F420 X21.299 Y13.614 E1.51783', ...
    '\n','G1 X25 Y13.029 E1.58015','\n','G1 X28.701 Y13.614 E1.64246' ...
    ,'\n','G1 X32.038 Y15.314 E1.70474','\n','G1 X34.686 Y17.962 E1.76702','\n','G1 X36.386 Y21.299 E1.8293', ...
    '\n','G1 X36.971 Y25 E1.89161','\n','G1 X36.386 Y28.701 E1.95392','\n','G1 X34.686 Y32.038 E2.0162', ...
    '\n','G1 X32.038 Y34.686 E2.07848','\n','G1 X28.701 Y36.386 E2.14076',...
    '\n','G1 X25 Y36.971 E2.20307','\n','G1 X21.299 Y36.386 E2.26538','\n','G1 X17.962 Y34.686 E2.32766', ...
    '\n','G1 X15.314 Y32.038 E2.38994','\n','G1 X13.614 Y28.701 E2.45222','\n','G1 X13.029 Y25 E2.51453', ...
    '\n','G1 X13.614 Y21.299 E2.57685','\n','G1 X15.314 Y17.962 E2.63913' ...
    ,'\n','G1 X17.962 Y15.314 E2.7014','\n','G0 F3600 X19.151 Y16.953','\n','G1 F420 X21.926 Y15.539 E2.7532', ...
    '\n','G1 X25 Y15.053 E2.80495', ...
    '\n','G1 X28.074 Y15.539 E2.85671','\n','G1 X30.849 Y16.953 E2.9085','\n','G1 X33.047 Y19.151 E2.9602', ...
    '\n','G1 X34.461 Y21.926 E3.01199','\n','G1 X34.947 Y25 E3.06375','\n','G1 X34.461 Y28.074 E3.1155' ...
    ,'\n','G1 X33.047 Y30.849 E3.1673','\n','G1 X30.849 Y33.047 E3.21899','\n','G1 X28.074 Y34.461 E3.27079', ...
    '\n','G1 X25 Y34.947 E3.32254', ...
    '\n','G1 X21.926 Y34.461 E3.3743','\n','G1 X19.151 Y33.047 E3.42609','\n','G1 X16.953 Y30.849 E3.47778', ...
    '\n','G1 X15.539 Y28.074 E3.52958','\n','G1 X15.053 Y25 E3.58133','\n','G1 X15.539 Y21.926 E3.63309' ...
    ,'\n','G1 X16.953 Y19.151 E3.68488','\n','G1 X19.151 Y16.953 E3.73658','\n','G0 F3600 X27.706 Y16.392', ...
    '\n','G1 F420 X33.607 Y22.293 E3.87536','\n','G0 F3600 X33.96 Y25.474', ...
    '\n','G1 F420 X24.525 Y16.04 E4.09725','\n','G0 F3600 X22.111 Y16.455','\n','G1 F420 X33.545 Y27.888 E4.36614', ...
    '\n','G0 F3600 X32.59 Y29.762','\n','G1 F420 X20.237 Y17.408 E4.65668' ...
    ,'\n','G0 F3600 X18.687 Y18.687','\n','G1 F420 X31.311 Y31.311 E4.95358','\n','G0 F3600 X29.761 Y32.589', ...
    '\n','G1 F420 X17.408 Y20.236 E5.2441','\n','G0 F3600 X16.454 Y22.111' ...
    ,'\n','G1 F420 X27.887 Y33.544 E5.51299','\n','G0 F3600 X25.474 Y33.959','\n','G1 F420 X16.039 Y24.524 E5.73488', ...
    '\n','G0 F3600 X16.392 Y27.705','\n','G1 F420 X22.292 Y33.606 E5.87365' ...
    ,'\n','G1 X22.645 Y33.959','\n','\n','\n','\n','\n'));

switch CellType
    case 'StretchDominatedDiamond'
        fprintf(fileID,strcat(';Coordinate data for diamond frame','\n'));
        NonExtrusionNodes=[1 6 6+nV*(nH-1)]; l=4;
        for m=1:(nH-2)
            NonExtrusionNodes(l)=6+m*nV; l=l+1;
        end
        for n=1:(nH-1)
            NonExtrusionNodes(l)=6+nV*(nH-1)+n*(5*nV+1); l=l+1;
        end
        for i=1:nL
            fprintf(fileID,strcat(';Layer',num2str(i), ...
                ' Z',num2str(2*i),'\n'));
            k=(i-1)*nExtr+1;
            for j=1:size(NodalPath,1)
                if ismember(j,NonExtrusionNodes)
                    fprintf(fileID,strcat('G0',' F3600', ...
                        ' X',num2str(nx(NodalPath(j))), ...
                        ' Y',num2str(ny(NodalPath(j))),'\n')); 
                else
                    fprintf(fileID,strcat('G1',' F420', ...
                        ' X',num2str(nx(NodalPath(j))), ...
                        ' Y',num2str(ny(NodalPath(j))), ...
                        ' E',num2str(E(k)),'\n')); k=k+1;
                end
            end 
            
            if i<nL % inter - layer drying time
                fprintf(fileID,strcat('\n','\n','\n','\n', ...
                    ';Interlayer time gap','\n','G0',' F3600', ...
                    ' X',num2str(nx(NodalPath(1))), ...
                    ' Y',num2str(ny(NodalPath(1))), ...
                    ' Z',num2str(2*(i+1)),'\n', ...
                    'G91','\n','G1',' Z200','\n','G4',' S300','\n', ...
                    'G1',' Z-200','\n','G90','\n','\n','\n','\n','\n'));
            end
        end
                              
    case 'BendingDominatedHexagon'
        fprintf(fileID,strcat(';Coordinate data for diamond frame ','\n'));
        for i=1:nL
            fprintf(fileID,strcat(';Layer',num2str(i), ...
                ' Z',num2str(2*i),'\n'));
            k=(i-1)*nExtr+1;
            fprintf(fileID,strcat('G0',' F3600', ...
                ' X',num2str(nx(NodalPath(1))), ...
                ' Y',num2str(ny(NodalPath(1))),'\n')); 
            if mod(nH,2)==1
                for j=2:size(NodalPath,1)
                    fprintf(fileID,strcat('G1',' F420', ...
                        ' X',num2str(nx(NodalPath(j))), ...
                        ' Y',num2str(ny(NodalPath(j))), ...
                        ' E',num2str(E(k)),'\n')); k=k+1;
                end
            else
                for j=2:size(NodalPath,1)
                    fprintf(fileID,strcat('G1',' F420', ...
                        ' X',num2str(nx(NodalPath(j))), ...
                        ' Y',num2str(ny(NodalPath(j))), ...
                        ' E',num2str(E(k)),'\n')); k=k+1;
                end
            end
            
            if i<nL % inter - layer drying time
                fprintf(fileID,strcat('\n','\n','\n','\n', ...
                    ';Interlayer time gap','\n','G0',' F3600', ...
                    ' X',num2str(nx(NodalPath(1))), ...
                    ' Y',num2str(ny(NodalPath(1))), ...
                    ' Z',num2str(2*(i+1)),'\n', ...
                    'G91','\n','G1',' Z200','\n','G4',' S300','\n', ...
                    'G1',' Z-200','\n','G90','\n','\n','\n','\n','\n'));
            end
        end    
end

% Final house-keeping commands
fprintf(fileID,strcat('\n','\n','\n','\n','\n',';End GCode','\n','M140 S0 ;heated bed heater off (if you have it)', ...
    '\n','G91 ;relative positioning','\n','G28;move X/Y to min endstops, so the head is out of the way','\n','M84 ;steppers off', ...
    '\n','M107','\n','G90 ;absolute positioning','\n','M82 ;absolute extrusion mode','\n',';End of Gcode'));

fclose(fileID);

% Open G-code file using Ultimaker Cura
% switch CellType
%     case 'StretchDominatedDiamond'
%         winopen('DiamondCellGcode.gcode'); 
%     case 'BendingDominatedHexagon'
%         winopen('HexagonalCellGcode.gcode');
% end
end